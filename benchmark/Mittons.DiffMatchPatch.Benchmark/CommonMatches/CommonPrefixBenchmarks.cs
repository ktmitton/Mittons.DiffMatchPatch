using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Order;
using Mittons.DiffMatchPatch.Benchmark.Original;
using Mittons.DiffMatchPatch.Extensions;

namespace Mittons.DiffMatchPatch.Benchmark.CommonMatches;

[MemoryDiagnoser]
[Orderer(SummaryOrderPolicy.FastestToSlowest)]
[RankColumn]
public class CommonPrefixBenchmarks
{
    public static readonly (string left, string right)[] TestCases = [
        ("abc", "xyz"),
        ("1234abcdef", "1234xyz"),
        ("1234", "1234xyz"),
        ("hello world", "hello universe"),
        ("abcdefg", "abcxyz"),
        ("12341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234abcdef", "12341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234xyz"),

        ("abc", "xyz"),
        ("abcdef1234", "xyz1234"),
        ("1234", "xyz1234"),
        ("world hello", "universe hello"),
        ("defgabc", "xyzabc"),
        ("abcdef12341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234", "xyz12341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234"),

        ("1234567890", "abcdef"),
        ("12345", "23"),
        ("1234567890", "a345678z"),
        ("a345678z", "1234567890"),
        ("abc56789z", "1234567890"),
        ("a23456xyz", "1234567890"),
        ("121231234123451234123121", "a1234123451234z"),
        ("x-=-=-=-=-=-=-=-=-=-=-=-=", "xx-=-=-=-=-=-=-="),
        ("-=-=-=-=-=-=-=-=-=-=-=-=y", "-=-=-=-=-=-=-=yy"),
        ("qHilloHelloHew", "xHelloHeHulloy"),
        ("abc12341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234def", "def12341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234123412341234abc"),

        ("", "abcd"),
        ("123456", "abcd"),
        ("abc", "abcd"),
        ("123456xxx", "xxxabcd"),
        ("fi", "\ufb01i"),
    ];

    public static diff_match_patch OriginalDiffMatchPatch = new();

    public static List<(bool hasCommonPrefix, string commonPrefix, int commonPrefixLength)> LegacyApproach()
    {
        List<(bool hasCommonPrefix, string commonPrefix, int commonPrefixLength)> results = [];
        foreach (var (left, right) in TestCases)
        {
            var commonPrefixLength = OriginalDiffMatchPatch.diff_commonPrefix(left, right);
            var hasCommonPrefix = commonPrefixLength > 0;
            var commonPrefix = left[..commonPrefixLength];
            results.Add((hasCommonPrefix, commonPrefix, commonPrefixLength));
        }
        return results;
    }

    public static List<(bool hasCommonPrefix, int commonPrefixLength)> NewApproach()
    {
        List<(bool hasCommonPrefix, int commonPrefixLength)> results = [];
        foreach (var (left, right) in TestCases)
        {
            var hasCommonPrefix = left.TryFindCommonPrefix(right, out var commonPrefix);
            var commonPrefixLength = commonPrefix.Length;
            results.Add((hasCommonPrefix, commonPrefixLength));
        }
        return results;
    }

    [Benchmark]
    public void BenchmarkLegacy()
    {
        LegacyApproach();
    }

    [Benchmark]
    public void BenchmarkNew()
    {
        NewApproach();
    }
}
